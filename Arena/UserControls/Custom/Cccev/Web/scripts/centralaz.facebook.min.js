(function(){var b=Object.prototype.hasOwnProperty,c=function(g,e){for(var d in e){if(b.call(e,d)){g[d]=e[d]}}function f(){this.constructor=g}f.prototype=e.prototype;g.prototype=new f;g.__super__=e.prototype;return g},a=function(d,e){return function(){return d.apply(e,arguments)}};window.CentralAZ=window.CentralAZ||{};CentralAZ.Facebook=CentralAZ.Facebook||{};CentralAZ.Facebook.Models=CentralAZ.Facebook.Models||{};CentralAZ.Facebook.Views=CentralAZ.Facebook.Views||{};CentralAZ.Facebook.Controllers=CentralAZ.Facebook.Controllers||{};CentralAZ.Facebook.Helpers=CentralAZ.Facebook.Helpers||{};CentralAZ.Facebook.Events=CentralAZ.Facebook.Events||{};CentralAZ.Facebook.Controllers.FacebookConnectRouter=(function(){c(d,Backbone.Router);function d(){d.__super__.constructor.apply(this,arguments)}d.prototype.routes={"":"index","*options":"index"};d.prototype.initialize=function(e){if(e.model){this.user=e.model}this.ev=e.events;this.user=e.model;this.indexView=new CentralAZ.Facebook.Views.FacebookConnectAccount({model:this.user,events:this.ev});_.bindAll(this);this.ev.bind("facebookLoggedIn",this.onLogin);this.ev.bind("userDeclined",this.onDecline);return this.ev.bind("connectAccountSuccessful",this.onConnected)};d.prototype.index=function(){return this.indexView.render()};d.prototype.onLogin=function(e){this.user=new CentralAZ.Facebook.Models.FacebookUser(e);return this.ev.trigger("connectAccounts")};d.prototype.onConnected=function(){console.log(this.user);this.connectedView=new CentralAZ.Facebook.Views.Connected({model:this.user,events:this.ev});this.indexView.close();return this.connectedView.render()};d.prototype.onDecline=function(){return this.indexView.close()};return d})();CentralAZ.Facebook.Models.FacebookUser=(function(){c(d,Backbone.Model);function d(){d.__super__.constructor.apply(this,arguments)}return d})();CentralAZ.Facebook.Views.Connected=(function(){c(d,Backbone.View);function d(){this.className="connect-success";this.tagName="div";this.template='<img src=\'https://graph.facebook.com/{{id}}/picture?type=square\' class="imageSmall" height="50" width="50" alt={{name}} />\n<p><strong>Sweet!</strong> {{name}}, you\'re all set!</p>';d.__super__.constructor.apply(this,arguments)}d.prototype.initialize=function(e){this.ev=e.events;return this.model=e.model};d.prototype.render=function(){var e,f,g;e=$(this.el);e.prependTo("body");f=this.model.toJSON();g=Mustache.to_html(this.template,f);e.html(g);return e.fadeIn("fast",a(function(){return setTimeout(a(function(){return e.fadeOut("fast",a(function(){return this.remove()},this))},this),5000)},this))};return d})();CentralAZ.Facebook.Models.FacebookUsers=(function(){c(d,Backbone.Collection);function d(){this.model=CentralAZ.Facebook.Models.FacebookUser}return d})();CentralAZ.Facebook.Controllers.FacebookLoginRouter=(function(){c(d,Backbone.Router);function d(){d.__super__.constructor.apply(this,arguments)}d.prototype.routes={"":"index","!/log-in/:status":"index","!/sign-up":"signUp","*other":"index"};d.prototype.initialize=function(e){this.user=e.model;this.ev=e.events;this.indexView=new CentralAZ.Facebook.Views.FacebookLogin({events:this.ev});_.bindAll(this);this.ev.bind("facebookLoggedIn",this.onLogin);this.ev.bind("facebookLogOut",this.onLogOut);this.ev.bind("userDeclined",this.onDecline);return this.ev.bind("arenaLoginFailed",this.onArenaLoginFail)};d.prototype.index=function(e){if(e==null){e=""}if(e==="declined"){alert("boo!")}return this.indexView.render()};d.prototype.signUp=function(){if(this.user===null){this.navigate("!/log-in",true);return}this.signUpView=new CentralAZ.Facebook.Views.FacebookSignUp({model:this.user,events:this.ev});return this.signUpView.render()};d.prototype.onLogin=function(e){var f;f=CentralAZ.Web.Helpers.UrlHelper.parseQueryString();if(f.error_reason!=null){this.user=new CentralAZ.Facebook.Models.FacebookUser({name:"anonymous person"});this.navigate("!/sign-up",true);return}if(!e){return this.navigate("!/log-in",true)}this.user=new CentralAZ.Facebook.Models.FacebookUser(e);this.userInfoView=new CentralAZ.Facebook.Views.FacebookWelcome({model:this.user,events:this.ev});this.userInfoView.render();return this.ev.trigger("arenaLogin")};d.prototype.onLogOut=function(){return this.navigate("!/log-in",true)};d.prototype.onDecline=function(){return this.navigate("!/log-in/declined",true)};d.prototype.onArenaLoginFail=function(){return this.navigate("!/sign-up",true)};return d})();CentralAZ.Facebook.Views.FacebookConnectAccount=(function(){c(d,Backbone.View);function d(){this.className="connect-account";this.tagName="div";this.template='<div class="close"><a href="#" class="fb-close">X</a></div>\n<p><strong>Hey {{name}}!</strong> We thought you might be interested in connecting your Central account to Facebook. \nThis will allow you to log into your Central account with a single click.</p>\n<p><a href="#" class="facebook-connect fbbutton" title="Connect to Facebook">Connect</a>\n<a href="#" class="fb-opt-out" title="Please don\'t ask me again">Please don\'t ask me again</a></p>';d.__super__.constructor.apply(this,arguments)}d.prototype.initialize=function(e){this.ev=e.events;this.model=e.model;_.bindAll(this);return this.ev.bind("optOutSuccessful",this.onOptedOut)};d.prototype.render=function(){var e,f;e=$(this.el);e.prependTo("body");f=Mustache.to_html(this.template,this.model.toJSON());e.html(f);this.inTimer=setTimeout(a(function(){return e.fadeIn("slow")},this),5000);return this.outTimer=setTimeout(a(function(){return this.close()},this),15000)};d.prototype.events={"click .facebook-connect":"connectAccount","click .fb-close":"close","click .fb-opt-out":"optOut"};d.prototype.connectAccount=function(){this.ev.trigger("facebookLogin");return false};d.prototype.close=function(){$(this.el).fadeOut("slow",a(function(){return $(this.el).remove()},this));clearTimeout(this.outTimer);return false};d.prototype.optOut=function(){this.ev.trigger("optOut");return false};d.prototype.onOptedOut=function(){return this.close()};return d})();CentralAZ.Facebook.Views.FacebookSignUp=(function(){c(d,Backbone.View);function d(){this.el="#signup-form";this.template='<h3>Hi {{name}}</h3>\n<img src=\'https://graph.facebook.com/{{id}}/picture?type=square\' class="imageSmall" height="50" width="50" alt={{name}} />\n<p><strong>Almost done!</strong> Just need to link your Central account to Facebook. Which of these options sounds right?</p>';this.unbind();d.__super__.constructor.apply(this,arguments)}d.prototype.initialize=function(e){this.ev=e.events;return _.bindAll(this,"logOut")};d.prototype.render=function(){var e,f;$(".greeting").empty();f=Mustache.to_html(this.template,this.model.toJSON());$(".greeting").html(f);$("input[id$='tbFirstName']").val(this.model.get("first_name"));$("input[id$='tbLastName']").val(this.model.get("last_name"));$("input[id$='tbEmail']").val(this.model.get("email"));$("input[id$='tbBirthdate']").val(this.model.get("birthday"));$("input[id$='ihAccessToken']").val(CentralAZ.Facebook.Helpers.Authentication.config.accessToken);$(".im-new, .have-account").next("div").hide();e=this;return $(this.el).siblings().fadeOut("slow",function(){$(e.el).fadeIn("slow");return false})};d.prototype.events={"click .fblogout":"logOut","click .im-new":"register","click .have-account":"signIn"};d.prototype.logOut=function(){this.ev.trigger("facebookLogOut");return false};d.prototype.register=function(){$(".have-account").next("div").slideUp();$(".im-new").next("div").slideToggle();return false};d.prototype.signIn=function(){$(".im-new").next("div").slideUp();$(".have-account").next("div").slideToggle();return false};d.prototype.unbind=function(){$(this.el).undelegate(".fb-logout","click");$(this.el).undelegate(".im-new","click");return $(this.el).undelegate(".have-account","click")};return d})();CentralAZ.Facebook.Views.FacebookWelcome=(function(){c(d,Backbone.View);function d(){this.el="#user-info";this.template='<img src=\'https://graph.facebook.com/{{id}}/picture?type=square\' class="imageSmall" height="50" width="50" alt={{name}} />\n<p>Welcome {{name}}! Hang tight, we\'re logging you in.</p>';d.__super__.constructor.apply(this,arguments)}d.prototype.initialize=function(e){return this.ev=e.events};d.prototype.render=function(){var f,e;f=$(this.el);e=Mustache.to_html(this.template,this.model.toJSON());return f.siblings().fadeOut("slow",function(){f.html(e);f.fadeIn("slow");return false})};return d})();CentralAZ.Facebook.Views.FacebookLogin=(function(){c(d,Backbone.View);function d(){this.el="#log-in";this.unbind();d.__super__.constructor.apply(this,arguments)}d.prototype.initialize=function(e){return this.ev=e.events};d.prototype.render=function(){var e;e=$(this.el);return $(".fb-auth > div").fadeOut("slow",function(){e.fadeIn("slow");return false})};d.prototype.events={"click .facebook-login":"logIn"};d.prototype.logIn=function(){this.ev.trigger("facebookLogin");return false};d.prototype.unbind=function(){return $(this.el).undelegate(".facebook-login","click")};return d})();CentralAZ.Facebook.Helpers.Authentication=(function(){function d(){}d.initConnect=function(f){var g;g=new CentralAZ.Facebook.Models.FacebookUser(f);window.facebookConnect=new CentralAZ.Facebook.Controllers.FacebookConnectRouter({model:g,events:facebookEvents});try{Backbone.history.start()}catch(e){}return d.registerFacebookApi()};d.initLogin=function(){window.facebookAuth=new CentralAZ.Facebook.Controllers.FacebookLoginRouter({model:null,events:facebookEvents});try{Backbone.history.start()}catch(e){}return d.registerFacebookApi()};d.registerFacebookApi=function(){var f;window.fbAsyncInit=function(){return FB.init({appId:d.config.appID,status:true,cookie:true,xfbml:true,oauth:true})};f=document.createElement("script");f.src=""+document.location.protocol+"//connect.facebook.net/en_US/all.js";f.async=true;return document.getElementById("fb-root").appendChild(f)};return d})();window.facebookEvents=_.extend(CentralAZ.Facebook.Events,Backbone.Events);facebookEvents.defaults={onLoginSuccess:function(d){if(d.d>-1){return window.location=CentralAZ.Facebook.Helpers.Authentication.config.redirectPath}else{return facebookEvents.trigger("arenaLoginFailed")}},onConnectSuccess:function(d){return facebookEvents.trigger("connectAccountSuccessful")},onOptOutSuccess:function(d){return facebookEvents.trigger("optOutSuccessful")},onError:function(d,e,f){console.log(JSON.stringify(d));console.log(e);return console.log(f)}};facebookEvents.bind("arenaLogin",function(g,e){var d,f;if(g==null){g=facebookEvents.defaults.onLoginSuccess}if(e==null){e=facebookEvents.defaults.onError}d=CentralAZ.Facebook.Helpers.Authentication.config.accessToken;f=CentralAZ.Facebook.Helpers.Authentication.config.state;return $.ajax({url:"webservices/custom/cccev/core/AuthenticationService.asmx/AuthenticateFacebook",type:"POST",data:"{'accessToken': '"+d+"', 'state': '"+f+"'}",contentType:"application/json",dataType:"json",success:g,error:e})});facebookEvents.bind("facebookLogin",function(){return FB.getLoginStatus(function(d){if(d.status==="connected"){return facebookEvents.trigger("facebookLoggingIn",d)}else{return FB.login(function(e){if(e.authResponse){return facebookEvents.trigger("facebookLoggingIn",e)}else{return facebookEvents.trigger("userDeclined")}},{scope:"email,user_birthday"})}})});facebookEvents.bind("facebookLoggingIn",function(d){CentralAZ.Facebook.Helpers.Authentication.config.accessToken=d.authResponse.accessToken;return FB.api("/me",function(e){return facebookEvents.trigger("facebookLoggedIn",e)})});facebookEvents.bind("facebookLogOut",function(){if(FB){return FB.logout()}});facebookEvents.bind("connectAccounts",function(g,e){var d,f;if(g==null){g=facebookEvents.defaults.onConnectSuccess}if(e==null){e=facebookEvents.defaults.onError}d=CentralAZ.Facebook.Helpers.Authentication.config.accessToken;f=CentralAZ.Facebook.Helpers.Authentication.config.state;return $.ajax({url:"webservices/custom/cccev/core/AuthenticationService.asmx/ConnectAccountToFacebook",type:"POST",data:"{'accessToken': '"+d+"', 'state': '"+f+"'}",contentType:"application/json",dataType:"json",success:g,error:e})});facebookEvents.bind("optOut",function(f,d){var e;if(f==null){f=facebookEvents.defaults.onOptOutSuccess}if(d==null){d=facebookEvents.defaults.onError}e=CentralAZ.Facebook.Helpers.Authentication.config.state;return $.ajax({url:"webservices/custom/cccev/core/AuthenticationService.asmx/OptOutOfFacebookConnection",type:"POST",data:"{'state': '"+e+"'}",contentType:"application/json",dataType:"json",success:f,error:d})})}).call(this);
